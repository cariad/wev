name: wev

on:  # yamllint disable-line rule:truthy
  - push

jobs:

  build:
    container: cariad/ci:1.3.0
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - name: Sync dependencies
        run: pipenv sync --dev

      - name: Version
        run: echo "${GITHUB_REF##*/}" > wev/VERSION

      - name: Build
        run: pipenv run ./build.sh

      - name: Archive distributable
        uses: actions/upload-artifact@v2
        with:
          name: distributable
          path: dist
          retention-days: 1

      - name: Archive documentation
        uses: actions/upload-artifact@v2
        with:
          name: docs
          path: site
          retention-days: 1


  test_code:
    container: cariad/ci:1.3.0
    needs: build
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2

      - name: Sync dependencies
        run: pipenv sync --dev

      - name: Download built distributable
        uses: actions/download-artifact@v2
        with:
          name: distributable

      - name: Install distributable
        run: pipenv install "$(ls *.whl)"

      - name: Test
        run: pipenv run ./test.sh

      - name: Publish test coverage
        uses: codecov/codecov-action@v1
        with:
          fail_ci_if_error: true
          verbose: true


  test_docs:
    container: cariad/ci:1.3.0
    needs: build
    runs-on: ubuntu-20.04
    steps:
      - name: Download built documentation
        uses: actions/download-artifact@v2
        with:
          name: docs

      - name: Test
        run: htmlproofer .              \
               --allow-hash-href        \
               --check-favicon          \
               --check-html             \
               --check-img-http         \
               --check-opengraph        \
               --disable-external       \
               --report-invalid-tags    \
               --report-missing-names   \
               --report-script-embeds   \
               --report-missing-doctype \
               --report-eof-tags        \
               --report-mismatched-tags

  test_cli:
    name: CLI test (Python ${{ matrix.python-version }})
    needs: build
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version:
          - "3.8"
          - "3.9"
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download build distributable
        uses: actions/download-artifact@v2
        with:
          name: distributable

      - name: Install distributable
        run: pip install "$(ls *.whl)"

      - name: Assert version
        run: |
          wev --version | tee version.tmp
          grep -qF "${GITHUB_REF##*/}" version.tmp
